name: Build and Deploy

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For creating Git tags
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for GitVersion to work properly

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v4
        with:
          versionSpec: '6.x'

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v4
        with:
          useConfigFile: true
          configFilePath: GitVersion.yml

      - name: Display GitVersion outputs
        run: |
          echo "SemVer: ${{ steps.gitversion.outputs.semVer }}"
          echo "FullSemVer: ${{ steps.gitversion.outputs.fullSemVer }}"
          echo "InformationalVersion: ${{ steps.gitversion.outputs.informationalVersion }}"
          echo "Major: ${{ steps.gitversion.outputs.major }}"
          echo "Minor: ${{ steps.gitversion.outputs.minor }}"
          echo "Patch: ${{ steps.gitversion.outputs.patch }}"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.slnx') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore src/Deckle.slnx

      - name: Build solution
        run: dotnet build src/Deckle.slnx --no-restore --configuration Release

      - name: Run tests
        run: dotnet test src/Deckle.slnx --no-build --configuration Release --logger "trx;LogFileName=test-results.trx" --collect:"XPlat Code Coverage"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/TestResults/**/*.trx'
          retention-days: 30

      - name: Upload code coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage
          path: '**/TestResults/**/coverage.cobertura.xml'
          retention-days: 30

      - name: Build API container
        run: |
          cd src
          docker build -f Deckle.API/Dockerfile -t deckle-api:local .

      - name: Build Web container
        run: |
          cd src/Deckle.Web
          docker build -t deckle-web:local .

      - name: Prepare docker-compose artifacts
        run: |
          # Copy template and replace environment variables with actual image names
          cp docker-compose-artifacts/docker-compose.yaml docker-compose-artifacts/docker-compose.yaml.template
          sed 's/\${API_IMAGE}/deckle-api:local/g; s/\${WEB_IMAGE}/deckle-web:local/g' docker-compose-artifacts/docker-compose.yaml.template > docker-compose-artifacts/docker-compose.yaml

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq for YAML parsing
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Extract metadata for images
        id: meta
        run: |
          echo "date=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT
          echo "sha_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Build and push Docker images
        if: github.event_name != 'pull_request'
        run: |
          set -euo pipefail
          cd docker-compose-artifacts

          # Use yq for reliable YAML parsing
          yq eval '.services.*.image' docker-compose.yaml | sort -u | while read -r image; do
            if [ -z "$image" ] || [ "$image" = "null" ]; then
              continue
            fi

            # Skip third-party images (postgres, aspire-dashboard, etc.)
            # Only process our application images that contain 'deckle'
            if ! echo "$image" | grep -q "deckle"; then
              echo "Skipping third-party image: $image"
              continue
            fi

            # Extract service name from image (remove path and tag)
            service_name=$(echo "$image" | sed 's/.*\///; s/:.*$//')

            echo "Processing image: $image (service: $service_name)"

            # Build GHCR image path
            ghcr_image="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${service_name}"

            # Tag with semantic versioning strategy
            docker tag "$image" "${ghcr_image}:${{ steps.gitversion.outputs.semVer }}"
            docker tag "$image" "${ghcr_image}:${{ steps.gitversion.outputs.major }}.${{ steps.gitversion.outputs.minor }}"
            docker tag "$image" "${ghcr_image}:${{ steps.gitversion.outputs.major }}"
            docker tag "$image" "${ghcr_image}:${{ steps.meta.outputs.sha_short }}"

            # Only tag as 'latest' for master/main branch stable releases
            if [[ "${{ steps.meta.outputs.branch }}" == "master" || "${{ steps.meta.outputs.branch }}" == "main" ]]; then
              docker tag "$image" "${ghcr_image}:latest"
            fi

            # Push all tags
            echo "Pushing tags to registry..."
            docker push "${ghcr_image}:${{ steps.gitversion.outputs.semVer }}"
            docker push "${ghcr_image}:${{ steps.gitversion.outputs.major }}.${{ steps.gitversion.outputs.minor }}"
            docker push "${ghcr_image}:${{ steps.gitversion.outputs.major }}"
            docker push "${ghcr_image}:${{ steps.meta.outputs.sha_short }}"

            # Push latest tag only for master/main
            if [[ "${{ steps.meta.outputs.branch }}" == "master" || "${{ steps.meta.outputs.branch }}" == "main" ]]; then
              docker push "${ghcr_image}:latest"
            fi

            echo "Successfully pushed: $service_name"
          done

      - name: Upload docker-compose artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-compose-artifacts
          path: docker-compose-artifacts/
          retention-days: 30

      - name: Create Git Tag
        if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.gitversion.outputs.semVer }}" -m "Release v${{ steps.gitversion.outputs.semVer }}"
          git push origin "v${{ steps.gitversion.outputs.semVer }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
